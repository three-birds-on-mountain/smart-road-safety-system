# Feature Specification: Background Alerts and Route Planning

**Feature Branch**: `002-background-alerts-route-planning`
**Created**: 2025-01-08
**Status**: Draft
**Input**: User description: "1. 讓警示通知和GPS可以在背景運行，即使使用者手機關著螢幕或沒有聚焦開啟app的情況下，也會偵測使用者是否接近危險路段並震動或音效提醒（提醒方式根據使用者的設定決定）
2. 設定最上方加入數量篩選，使用Range Slider，預設為1，最大為10，假設選3，代表總事故數超過3筆時才會顯示在畫面上並提醒
3. 畫面上方加入input，可搜尋目的地地址
    3-1. 使用Mapbox做路線規劃，繪製出使用者現在定位到目的地的路線
    3-2. 第一次搜尋後，搜尋框會變成兩個，上方搜尋框顯示「你的位置」，下方搜尋框顯示使用者剛才輸入的目的地地址，此時使用者可以調整目的地及起始地點，調整完後路線也會更改
    3-3. 該路線會經過的所有事故（根據設定來篩選，路線上會被警示的所有事故）全部加總，下方出現drawer説經過路段共有{}筆車禍，A1有{}筆(根據設定決定顯示哪些事故等級)，假設超過{}起資料則建議使用者搭乘大眾交通工具"

## User Scenarios & Testing

### User Story 1 - Background Safety Monitoring (Priority: P1)

機車騎士小明在騎車通勤時，將手機放在口袋中並關閉螢幕以節省電量。當他接近一個事故熱點區域時，即使螢幕關閉，手機仍會根據他的設定（震動或音效）發出警示，提醒他注意安全。

**Why this priority**: 這是核心安全功能，直接關係到使用者的行車安全。許多騎士在騎車時無法持續查看手機，背景監控是必要功能。

**Independent Test**: 可以透過以下方式獨立測試：(1) 關閉螢幕或切換到其他 app，(2) 模擬或實際移動至事故熱點附近，(3) 驗證是否收到警示通知（震動或音效），即可證明此功能正常運作並提供核心價值。

**Acceptance Scenarios**:

1. **Given** 使用者已開啟應用程式並授予定位權限，**When** 使用者關閉手機螢幕並移動至距離事故熱點 200 公尺內，**Then** 系統應根據使用者設定觸發震動或音效警示
2. **Given** 使用者正在使用其他應用程式（如音樂播放器），**When** 使用者進入事故熱點警示範圍，**Then** 系統應在背景觸發警示而不中斷其他應用程式
3. **Given** 使用者已在設定中選擇「僅震動」，**When** 背景偵測到事故熱點，**Then** 系統應僅觸發震動而不播放音效
4. **Given** 使用者已在設定中選擇「震動+音效」，**When** 背景偵測到事故熱點，**Then** 系統應同時觸發震動和音效

---

### User Story 2 - Accident Threshold Filtering (Priority: P2)

使用者小華希望只關注事故數量較多的危險路段，不想被單一事故的熱點干擾。她在設定中將數量篩選調整為「3」，這樣系統只會顯示和警示總事故數超過 3 筆的熱點。

**Why this priority**: 此功能讓使用者能夠根據個人需求自訂警示敏感度，避免警示疲勞，提升使用體驗。這是增強核心功能的重要配置選項。

**Independent Test**: 可以透過以下方式獨立測試：(1) 在設定中調整數量篩選滑桿至特定值（如 3），(2) 觀察地圖上顯示的熱點數量減少（只顯示事故數 ≥3 的熱點），(3) 移動至事故數 <3 的熱點附近驗證不會收到警示，(4) 移動至事故數 ≥3 的熱點附近驗證會收到警示。

**Acceptance Scenarios**:

1. **Given** 使用者開啟設定頁面，**When** 使用者看到數量篩選滑桿，**Then** 滑桿應顯示預設值為 1，範圍為 1-10
2. **Given** 使用者將數量篩選設定為 3，**When** 使用者回到地圖頁面，**Then** 地圖上只顯示總事故數 ≥3 的熱點
3. **Given** 使用者將數量篩選設定為 5，**When** 使用者接近一個總事故數為 3 的熱點，**Then** 系統不應觸發警示
4. **Given** 使用者將數量篩選設定為 5，**When** 使用者接近一個總事故數為 7 的熱點，**Then** 系統應觸發警示

---

### User Story 3 - Route Planning with Safety Assessment (Priority: P3)

使用者小李計劃騎車前往一個新地點，他在應用程式中輸入目的地地址。系統規劃出一條路線並顯示在地圖上。路線完成後，畫面下方出現一個資訊卡，顯示「此路線經過路段共有 12 筆車禍，其中 A1 有 2 筆，A2 有 5 筆，A3 有 5 筆。建議考慮使用大眾交通工具。」小李可以根據這個資訊決定是否調整路線或改用其他交通方式。

**Why this priority**: 路線規劃是進階功能，讓使用者能夠在出發前評估路線安全性。雖然不是核心即時警示功能，但對於計劃行程的使用者很有價值。

**Independent Test**: 可以透過以下方式獨立測試：(1) 在搜尋框輸入目的地地址，(2) 驗證地圖上顯示從目前位置到目的地的路線，(3) 驗證畫面下方顯示路線事故統計資訊（總數及各等級數量），(4) 驗證是否根據事故數量顯示建議訊息，即可證明此功能提供路線安全評估價值。

**Acceptance Scenarios**:

1. **Given** 使用者在地圖頁面，**When** 使用者點擊畫面上方的搜尋框並輸入目的地地址，**Then** 系統應顯示搜尋建議並允許使用者選擇
2. **Given** 使用者選擇了一個目的地，**When** 系統計算路線，**Then** 地圖上應顯示從使用者目前位置到目的地的路線
3. **Given** 路線規劃完成，**When** 系統計算路線經過的事故熱點，**Then** 畫面下方應顯示事故統計資訊（總數及 A1/A2/A3 分類數量，根據設定的嚴重程度篩選）
4. **Given** 路線經過的事故風險評分超過閾值（基於加權計算），**When** 系統評估路線安全性，**Then** 應顯示「建議使用大眾交通工具」的訊息
5. **Given** 使用者已搜尋過一次目的地，**When** 畫面顯示兩個搜尋框（上方為起點，下方為目的地），**Then** 使用者應能夠修改起點或目的地，系統會即時更新路線和事故統計

---

### User Story 4 - Flexible Route Adjustment (Priority: P3)

使用者小陳在規劃路線後，發現預設起點不是自己想要的出發地。他點擊上方的「你的位置」搜尋框，改成另一個地址作為起點。系統重新規劃路線並更新事故統計資訊，讓他能比較不同起點的路線安全性。

**Why this priority**: 這是路線規劃功能的增強，提供更大的彈性。對於需要從非目前位置出發的使用者很有幫助，但不是基本路線規劃的必要功能。

**Independent Test**: 可以透過以下方式獨立測試：(1) 先完成一次目的地搜尋（觸發 User Story 3），(2) 點擊上方的起點搜尋框並輸入新地址，(3) 驗證路線重新規劃，(4) 驗證事故統計更新，即可證明此功能提供路線調整價值。

**Acceptance Scenarios**:

1. **Given** 使用者已完成一次路線規劃，**When** 使用者點擊上方的起點搜尋框，**Then** 系統應允許使用者輸入或選擇新的起點地址
2. **Given** 使用者修改起點或目的地，**When** 地址變更確認，**Then** 系統應重新規劃路線並更新地圖顯示
3. **Given** 使用者修改起點或目的地，**When** 路線重新規劃完成，**Then** 畫面下方的事故統計資訊應即時更新

---

### Edge Cases

- **背景權限限制**: 不同作業系統（iOS/Android）對背景定位和通知有不同的權限限制。如果使用者未授予背景定位權限或系統終止背景服務，如何處理？
- **GPS 訊號不穩定**: 在隧道、室內或訊號不佳區域，GPS 定位可能不準確或中斷。背景監控如何處理？
- **電量消耗**: 背景持續運行 GPS 會消耗電量。是否需要提供省電模式或警告使用者？
- **路線無法規劃**: 如果使用者輸入的地址無法找到或無法規劃路線（如海上、國外），系統應如何回應？
- **路線上無事故資料**: 如果規劃的路線完全沒有經過任何事故熱點，統計資訊應顯示什麼？
- **數量篩選與路線統計衝突**: 如果使用者設定數量篩選為 5，但路線上有一個事故數為 3 的熱點，這個熱點是否應計入路線統計？
- **同時多個警示**: 如果使用者同時進入多個事故熱點範圍，系統應如何處理警示（一次觸發 vs. 連續觸發）？
- **離線狀態**: 如果使用者在路線規劃或背景監控時失去網路連線，系統應如何處理？

## Requirements

### Functional Requirements

- **FR-001**: 系統必須能夠在應用程式位於背景或螢幕關閉時，持續追蹤使用者的 GPS 位置
- **FR-002**: 系統必須在使用者進入事故熱點警示範圍時，觸發警示通知（震動或音效，根據使用者設定）
- **FR-003**: 系統必須提供警示方式設定選項，包括：僅震動、僅音效、震動+音效、關閉警示
- **FR-004**: 系統必須在設定頁面提供數量篩選功能，使用滑桿介面，範圍為 1-10，預設值為 1
- **FR-005**: 系統必須根據數量篩選設定，只顯示和警示總事故數大於或等於設定值的熱點
- **FR-006**: 系統必須提供目的地地址搜尋功能，支援地址輸入和自動完成建議
- **FR-007**: 系統必須能夠規劃從使用者目前位置到目的地的路線，並在地圖上顯示
- **FR-008**: 系統必須計算路線經過的所有事故熱點（根據設定的嚴重程度篩選和數量篩選），並統計總數及各等級（A1/A2/A3）數量
- **FR-009**: 系統必須在路線規劃後，於畫面下方顯示事故統計資訊，包括總數和各等級分類
- **FR-010**: 系統必須在第一次搜尋目的地後，將搜尋框擴展為兩個（起點和目的地），允許使用者調整
- **FR-011**: 系統必須在使用者修改起點或目的地後，即時重新規劃路線並更新事故統計
- **FR-012**: 系統必須根據路線經過的事故風險評分，當評分超過閾值時顯示「建議使用大眾交通工具」的訊息。風險評分採用加權計算（A1、A2、A3 事故有不同權重）[TODO: 確定最終的加權公式和閾值，目前暫定 A1=3分、A2=2分、A3=1分，總分超過 15 分時建議]
- **FR-013**: 系統必須在使用者首次開啟背景功能時，引導使用者授予必要的背景定位和通知權限
- **FR-014**: 系統必須在使用者拒絕背景權限或系統限制背景服務時，顯示明確的錯誤訊息和引導

### Key Entities

- **路線 (Route)**: 代表從起點到目的地的規劃路徑，包含路徑座標序列、總距離、預估時間、經過的事故熱點清單
- **路線事故統計 (Route Safety Summary)**: 路線安全性評估資訊，包含總事故數、各等級事故數（A1/A2/A3）、風險評分（加權計算）、是否建議使用大眾交通工具 [TODO: 加權公式待確定]
- **背景警示設定 (Background Alert Settings)**: 使用者的警示偏好設定，包含警示方式（震動/音效/兩者/關閉）、數量篩選閾值
- **搜尋記錄 (Search History)**: 使用者搜尋過的地址記錄，用於自動完成建議

## Success Criteria

### Measurable Outcomes

- **SC-001**: 使用者能夠在螢幕關閉或切換到其他應用程式時，在進入事故熱點 200 公尺範圍內的 5 秒內收到警示通知
- **SC-002**: 背景監控功能在連續運行 2 小時內，電池消耗不超過 10%
- **SC-003**: 使用者能夠在 30 秒內完成目的地搜尋並看到規劃的路線和事故統計
- **SC-004**: 路線規劃的事故統計準確率達到 95%（正確識別路線 200 公尺範圍內的所有事故熱點）
- **SC-005**: 使用者調整數量篩選設定後，地圖顯示和警示行為能在 2 秒內更新
- **SC-006**: 使用者修改起點或目的地後，路線和事故統計能在 10 秒內重新規劃完成
- **SC-007**: 90% 的使用者能夠在首次使用時成功設定背景權限和警示方式

### Assumptions

- 使用者已授予應用程式基本的定位和通知權限
- 使用者的裝置支援背景定位服務（可能需要作業系統版本要求）
- 地圖服務（Mapbox）提供可靠的路線規劃 API
- 事故資料庫已包含足夠的歷史事故資料供統計和顯示
- 「建議使用大眾交通工具」採用加權風險評分機制：A1 事故權重 3 分、A2 權重 2 分、A3 權重 1 分，總分超過 15 分時觸發建議 [TODO: 最終公式和閾值待確定]
- 路線事故統計範圍為路線兩側 200 公尺內的事故熱點
- 數量篩選同時影響地圖顯示和警示行為（即篩選掉的熱點既不顯示也不警示）
