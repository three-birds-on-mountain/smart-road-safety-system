# Feature Specification: 智慧道路守護系統 (Smart Road Safety System)

**Feature Branch**: `001-road-safety-system`
**Created**: 2025-11-02
**Status**: Draft
**Input**: 透過分析交通事故資料與AI熱點偵測，結合GPS定位提供駕駛者即時危險提醒，降低車禍風險、提升行車安全。系統核心概念包括：利用公開A1、A2、A3事故資料建構事故資料庫、定期進行交通事故熱點分析、在地圖上顯示危險警示、允許用戶選擇提醒距離與事故等級。

## Clarifications

### Session 2025-11-02

- Q: 系統是否進行AI預測性分析（預測未來可能發生事故的位置）？ → A: 沒有AI熱點預測，系統僅分析已發生的歷史事故資料進行熱點識別
- Q: 警示方式除了語音與視覺外，還有哪些選項？ → A: 可設定音效、震動提醒或不提醒
- Q: 除了距離與事故等級外，是否需要其他篩選維度？ → A: 另外加上時間維度呈現（一年內、半年內、三個月內、一個月內）
- Q: 當用戶選擇「三個月內」作為事故時間範圍篩選，系統應該如何判斷一個熱點是否符合條件？ → A: 熱點內「至少一起事故」是在三個月內發生的（寬鬆模式）
- Q: 當用戶設定警示方式為「不提醒」時，系統的行為應該是什麼？ → A: 不發出聲音/震動警示，但當進入熱點時仍在螢幕上短暫顯示視覺提示（如小圖示）
- Q: 用戶是否可以同時選擇多種警示方式（例如：同時啟用音效+震動）？ → A: 可以，用戶可勾選多個選項組合（例如：音效+震動）
- Q: 系統在進行熱點分析時，預設應該考慮多久以前的歷史事故資料來識別熱點？ → A: 一年內
- Q: 當用戶改變時間範圍設定（例如從「一年內」改為「三個月內」）後，熱點資料應該如何更新？ → A: 即時篩選：系統使用預先計算好的一年內熱點資料，依照用戶選擇的時間範圍即時篩選顯示
- Q: 警示方式是否包含語音播報功能？ → A: 語音播報不要，只提供音效、震動、不提醒三種選項
- Q: 是否需要「忽略特定熱點」的功能？ → A: 不需要，為了維持 MVP 精簡與設定一致性，「忽略熱點」功能已被移除

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 即時危險區域警示 (Priority: P1)

駕駛者在行駛過程中，當接近或進入交通事故熱點區域時，系統根據用戶設定的警示方式（音效、震動或無提醒）與螢幕視覺提示，提醒駕駛者注意行車安全。

**Why this priority**: 這是系統的核心價值主張，直接關係到提升行車安全的目標。沒有這個功能，系統就失去存在意義。

**Independent Test**: 可以透過模擬GPS座標進入已知的事故熱點區域，驗證系統是否依照設定的警示方式（音效/震動）與視覺提示正確發出警示。

**Acceptance Scenarios**:

1. **Given** 用戶已開啟App並啟用GPS定位，設定警示方式為「音效」，**When** 用戶移動到距離事故熱點100公尺範圍內（根據用戶設定的提醒距離），**Then** 系統立即播放音效並在螢幕上顯示警示圖示與熱點資訊（包含事故等級、事故數量）
2. **Given** 用戶正在事故熱點區域內行駛，**When** 用戶離開該熱點區域（超出設定的提醒距離），**Then** 系統停止警示並清除視覺提示
3. **Given** 用戶設定警示方式為「震動」，**When** 用戶進入事故熱點區域，**Then** 系統觸發震動並顯示視覺提示，但不播放任何聲音

---

### User Story 2 - 客製化警示設定 (Priority: P2)

用戶可以根據個人需求調整警示設定，包括：提醒距離（100m/500m/1km/3km）、關注的事故等級（A1/A2/A3）、警示方式（音效/震動/不提醒）、以及事故時間範圍篩選（一年內/半年內/三個月內/一個月內）。

**Why this priority**: 不同駕駛者對警示的敏感度和需求不同，提供客製化設定可以提升用戶體驗，避免過度警示造成困擾。

**Independent Test**: 可以透過調整設定並模擬GPS移動，驗證系統是否依照設定的條件（距離、事故等級、時間範圍、警示方式）正確觸發或不觸發警示。

**Acceptance Scenarios**:

1. **Given** 用戶在設定頁面，**When** 用戶選擇提醒距離為「1公里」、只關注「A1事故」、時間範圍「三個月內」，**Then** 系統儲存設定並在後續只在距離三個月內發生的A1事故熱點1公里內發出警示
2. **Given** 用戶設定警示方式為「震動」，**When** 用戶進入事故熱點區域，**Then** 系統僅震動並顯示視覺警示，不播放任何聲音
3. **Given** 用戶選擇關注所有等級事故（A1/A2/A3）且時間範圍為「一年內」，**When** 用戶進入任何在過去一年內發生事故的熱點區域，**Then** 系統都會發出警示
4. **Given** 用戶設定警示方式為「不提醒」，**When** 用戶進入事故熱點區域，**Then** 系統在螢幕上短暫顯示視覺提示圖示，但不發出任何聲音或震動警示
5. **Given** 用戶同時勾選「音效」與「震動」作為警示方式，**When** 用戶進入事故熱點區域，**Then** 系統同時播放音效並觸發震動，並顯示視覺提示

---

### User Story 3 - 地圖視覺化熱點資訊 (Priority: P3)

用戶可以在地圖上查看所在區域的事故熱點分布，包括熱點位置、範圍、事故數量、事故等級比例等資訊。

**Why this priority**: 提供視覺化資訊可以幫助用戶主動規劃更安全的行駛路線，但相比即時警示功能，這是次要的輔助功能。

**Independent Test**: 可以透過開啟地圖頁面並檢視已知位置的熱點標記，驗證熱點資訊是否正確顯示。

**Acceptance Scenarios**:

1. **Given** 用戶開啟地圖頁面，**When** 地圖載入完成，**Then** 系統在地圖上顯示所有事故熱點的標記（依照事故嚴重程度使用不同顏色/圖示）
2. **Given** 用戶點擊地圖上的熱點標記，**When** 熱點資訊彈窗顯示，**Then** 彈窗內容包含：熱點中心座標、影響範圍半徑、總事故數量、A1/A2/A3事故比例
3. **Given** 用戶移動地圖或縮放，**When** 地圖範圍改變，**Then** 系統動態更新顯示該範圍內的熱點標記

---

### Edge Cases

- 當GPS訊號不穩定或遺失時，系統應顯示「GPS訊號弱」提示，暫停警示功能直到訊號恢復
- 當用戶快速移動（例如高速公路行駛）穿越多個熱點區域時，系統應避免連續重複警示造成干擾（設定最小警示間隔，例如30秒）
- 當資料庫尚未完成熱點分析或資料不可用時，系統應顯示「資料更新中」訊息，並暫時無法提供警示服務
- 當用戶同時在多個重疊的熱點區域內時，系統應優先顯示最嚴重等級（A1 > A2 > A3）的熱點資訊
- 當地圖上熱點數量過多時（例如縮小地圖顯示整個台灣），系統應進行聚合顯示或只顯示高優先級熱點，避免畫面過於擁擠

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統必須能夠每月自動從台灣內政部與政府開放資料平台擷取A1、A2、A3交通事故資料
- **FR-002**: 系統必須將A2事故資料的ZIP檔案解壓縮並解析其中的JSON檔案
- **FR-003**: 系統必須將A3事故資料中的地點文字描述轉換為經緯度座標（透過地理編碼服務）
- **FR-004**: 系統必須統一所有事故資料的欄位格式，包含：時間、地點、車禍等級、經度、緯度、車種（或行人）
- **FR-005**: 系統必須將清洗後的事故資料儲存至支援地理空間查詢的資料庫
- **FR-006**: 系統必須每日執行事故熱點分析，使用地理聚類演算法識別高風險區域，分析範圍為過去一年內的事故資料
- **FR-007**: 系統必須為每個識別出的熱點儲存以下資訊：中心座標、影響半徑、事故總數、事故等級分布
- **FR-008**: 系統必須持續讀取用戶的GPS位置（當App在前景執行時）
- **FR-009**: 系統必須即時比對用戶位置與事故熱點資料庫，判斷是否進入警示範圍
- **FR-010**: 當用戶進入警示範圍時，系統必須根據用戶設定的警示方式發出對應的警示（音效/震動）與視覺提示
- **FR-011**: 系統必須允許用戶選擇提醒距離（100公尺、500公尺、1公里、3公里）
- **FR-012**: 系統必須允許用戶篩選關注的事故等級（A1、A2、A3或任意組合）
- **FR-013**: 系統必須允許用戶選擇一種或多種警示方式組合（音效、震動、不提醒），當選擇「不提醒」時仍保留螢幕視覺提示但不發出聲音或震動。**實作說明**：前端使用 `alertChannels: ['sound', 'vibration']` 陣列表示，空陣列 `[]` 代表「不提醒」模式
- **FR-021**: 系統必須支援多重警示方式同時觸發（例如：同時播放音效並觸發震動）
- **FR-019**: 系統必須允許用戶選擇事故時間範圍篩選（一年內、半年內、三個月內、一個月內）。**格式映射**：前端使用簡寫格式 `'1Y' | '6M' | '3M' | '1M'`，後端 API 使用 `'1_year' | '6_months' | '3_months' | '1_month'`，前端需進行格式轉換
- **FR-020**: 系統必須根據用戶選擇的時間範圍，即時篩選並只顯示與警示至少包含一起該時間範圍內發生事故的熱點（例如：選擇「三個月內」時，只顯示包含至少一起在過去三個月內發生事故的熱點）
- **FR-022**: 系統必須在熱點資料中保留每個事故的時間戳記，以支援用戶設定時間範圍的即時篩選
- **FR-014**: 系統必須在地圖上視覺化顯示事故熱點的位置與範圍
- **FR-015**: 系統必須允許用戶點擊熱點標記查看詳細資訊（事故數量、等級比例等）
- **FR-016**: 系統必須在GPS訊號不穩定時顯示警告訊息並暫停警示功能
- **FR-017**: 系統必須記錄用戶的警示設定並在App重啟後保留
- **FR-018**: 系統必須避免在短時間內（建議30秒內）對同一熱點區域重複警示
- **FR-023**: 不再提供「忽略單一熱點」功能，所有熱點皆依距離、嚴重程度與時間範圍即時判斷是否需提醒

### Key Entities

- **交通事故記錄 (Accident Record)**: 代表單一交通事故的原始資料，包含屬性：事故發生時間、地點描述、經緯度座標、事故等級（A1/A2/A3）、涉及車種或行人
- **事故熱點 (Accident Hotspot)**: 代表透過地理聚類分析產生的高風險區域，包含屬性：熱點中心座標（經度、緯度）、影響半徑（公尺）、包含的事故總數、各等級事故的數量與比例、最後更新時間、涵蓋事故的時間範圍（最早與最晚事故發生時間）
- **用戶警示設定 (User Alert Settings)**: 代表用戶的個人化警示偏好，包含屬性：
  - 提醒距離：100m/500m/1km/3km（前端與後端值相同：100, 500, 1000, 3000）
  - 關注的事故等級：A1/A2/A3 的組合（前端值：`['A1', 'A2', 'A3']` 陣列）
  - 警示方式：音效/震動/不提醒（前端值：`['sound', 'vibration']` 陣列，空陣列代表不提醒）
  - 事故時間範圍篩選：一年內/半年內/三個月內/一個月內（前端值：`'1Y'|'6M'|'3M'|'1M'`，API 值：`'1_year'|'6_months'|'3_months'|'1_month'`）
  - （移除）忽略熱點清單：最新決議中不再記錄 `ignoredHotspotIds`，所有熱點依距離/嚴重度/時間範圍即時判斷是否觸發警示

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 系統每月成功擷取並整合至少95%的公開事故資料（A1、A2、A3）
- **SC-002**: 系統每日熱點分析作業能在2小時內完成，確保資料新鮮度
- **SC-003**: 當用戶進入事故熱點警示範圍時，系統在3秒內發出警示
- **SC-004**: 系統在GPS訊號正常時，位置更新頻率至少每5秒一次，確保即時性
- **SC-005**: 地圖頁面載入並顯示當前可見範圍內的所有熱點標記，時間不超過2秒
- **SC-006**: 90%的用戶能在首次使用時順利完成警示設定（距離與事故等級選擇）
- **SC-007**: 系統在連續使用1小時期間，不因記憶體或效能問題導致當機或異常
- **SC-008**: 當用戶改變時間範圍設定時，系統在1秒內完成熱點資料篩選並更新顯示

### Assumptions

- 假設用戶設備具備GPS定位能力且已授予App定位權限
- 假設用戶設備在使用期間能夠連接網路以載入地圖資料與熱點資訊
- 假設政府公開資料API的可用性與資料格式維持穩定
- 假設用戶使用情境為駕駛車輛時將App保持在前景（不考慮背景持續監控）
- 假設App儲存的用戶設定為本地儲存，不需要用戶帳號或雲端同步
- 假設地理編碼服務的配額足夠支援A3事故資料的地點轉換需求（將地址文字轉換為經緯度座標）
- 假設熱點分析使用的聚類演算法參數（如最小事故數、聚類半徑）將由開發團隊根據實際測試結果調整
- 假設系統熱點分析使用過去一年內的事故資料，超過一年的歷史資料不納入熱點計算
