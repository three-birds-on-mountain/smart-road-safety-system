# ç†±é»åˆ†æ ETL è…³æœ¬

## generate_hotspots.py

å¾ `accidents` table ç”Ÿæˆ `hotspots` table çš„ ETL è…³æœ¬ã€‚

### åŠŸèƒ½èªªæ˜

æ­¤è…³æœ¬æœƒï¼š

1. **è®€å–äº‹æ•…è³‡æ–™**ï¼šå¾ `accidents` table è®€å–æŒ‡å®šæ™‚é–“ç¯„åœå…§çš„äº‹æ•…è¨˜éŒ„
2. **èšé¡åˆ†æ**ï¼šä½¿ç”¨ DBSCAN æ¼”ç®—æ³•è­˜åˆ¥äº‹æ•…å¯†é›†å€åŸŸï¼ˆç†±é»ï¼‰
3. **è¨ˆç®—çµ±è¨ˆ**ï¼šç‚ºæ¯å€‹ç†±é»è¨ˆç®—ä¸­å¿ƒé»ã€åŠå¾‘ã€äº‹æ•…æ•¸ã€åš´é‡ç¨‹åº¦åˆ†å¸ƒç­‰
4. **å¯«å…¥è³‡æ–™åº«**ï¼šå°‡ç†±é»è³‡æ–™å¯«å…¥ `hotspots` table

### å‰ç½®éœ€æ±‚

```bash
# å®‰è£å¿…è¦å¥—ä»¶
uv add psycopg2-binary scikit-learn geopy
```

### ä½¿ç”¨æ–¹å¼

#### åŸºæœ¬ç”¨æ³•

```bash
# åˆ†æéå»ä¸€å¹´çš„äº‹æ•…è³‡æ–™ï¼Œç”Ÿæˆç†±é»
uv run python generate_hotspots.py --database-url "$DATABASE_URL"
```

#### å¸¸ç”¨åƒæ•¸

```bash
# æŒ‡å®šåˆ†ææ™‚é–“ç¯„åœï¼ˆéå» 180 å¤©ï¼‰
uv run python data/generate_hotspots.py \
  --database-url "$DATABASE_URL" \
  --period-days 180

# èª¿æ•´ DBSCAN åƒæ•¸ï¼ˆæ›´åš´æ ¼çš„èšé¡æ¢ä»¶ï¼‰
uv run python data/generate_hotspots.py \
  --database-url "$DATABASE_URL" \
  --epsilon-meters 300 \
  --min-accidents 10

# æ¸…é™¤èˆŠçš„ç†±é»è³‡æ–™
uv run python data/generate_hotspots.py \
  --database-url "$DATABASE_URL" \
  --clear-existing

# æ¸¬è©¦æ¨¡å¼ï¼ˆä¸å¯«å…¥è³‡æ–™åº«ï¼‰
uv run python data/generate_hotspots.py \
  --database-url "$DATABASE_URL" \
  --dry-run
```

### åƒæ•¸èªªæ˜

| åƒæ•¸               | èªªæ˜                                  | é è¨­å€¼ |
| ------------------ | ------------------------------------- | ------ |
| `--database-url`   | PostgreSQL é€£ç·šå­—ä¸²ï¼ˆå¿…å¡«ï¼‰           | -      |
| `--period-days`    | åˆ†æéå»å¹¾å¤©çš„äº‹æ•…è³‡æ–™                | 365    |
| `--epsilon-meters` | DBSCAN epsilon åƒæ•¸ï¼šèšé¡åŠå¾‘ï¼ˆå…¬å°ºï¼‰ | 500    |
| `--min-accidents`  | DBSCAN min_samples åƒæ•¸ï¼šæœ€å°äº‹æ•…æ•¸   | 5      |
| `--clear-existing` | æ¸…é™¤ç¾æœ‰çš„ hotspots è³‡æ–™              | false  |
| `--dry-run`        | æ¸¬è©¦æ¨¡å¼ï¼šä¸å¯«å…¥è³‡æ–™åº«                | false  |

### DBSCAN åƒæ•¸èª¿æ•´å»ºè­°

#### epsilon-metersï¼ˆèšé¡åŠå¾‘ï¼‰

- **500mï¼ˆé è¨­ï¼‰**ï¼šé©åˆä¸€èˆ¬é“è·¯
- **300m**ï¼šé©åˆå¸‚å€å¯†é›†è·¯æ®µ
- **800-1000m**ï¼šé©åˆéƒŠå€æˆ–é«˜é€Ÿå…¬è·¯

#### min-accidentsï¼ˆæœ€å°äº‹æ•…æ•¸ï¼‰

- **5ï¼ˆé è¨­ï¼‰**ï¼šé©åˆä¸€èˆ¬åˆ†æ
- **10 ä»¥ä¸Š**ï¼šåªé—œæ³¨é«˜é¢¨éšªç†±é»
- **3**ï¼šåŒ…å«è¼ƒå°çš„äº‹æ•…ç¾¤é›†

### è¼¸å‡ºç¯„ä¾‹

```
============================================================
ğŸš¦ äº‹æ•…ç†±é» ETL è…³æœ¬
============================================================
åˆ†ææœŸé–“: éå» 365 å¤©
DBSCAN åƒæ•¸: epsilon=500m, min_samples=5
æ¸¬è©¦æ¨¡å¼: å¦
============================================================
âœ… è³‡æ–™åº«é€£ç·šæˆåŠŸ

ğŸ“Š è®€å– 2024-11-08 ä¹‹å¾Œçš„äº‹æ•…è³‡æ–™...
âœ… è®€å– 1523 ç­†äº‹æ•…è¨˜éŒ„

ğŸ”¬ åŸ·è¡Œ DBSCAN èšé¡åˆ†æ...
   åƒæ•¸: epsilon=500m, min_samples=5
âœ… èšé¡å®Œæˆï¼š
   - ç™¼ç¾ 23 å€‹ç†±é»
   - å™ªéŸ³é»ï¼ˆæœªæ­¸é¡äº‹æ•…ï¼‰: 412 ç­†

ğŸ“ˆ ç”Ÿæˆç†±é»è¨˜éŒ„...
âœ… ç”Ÿæˆ 23 ç­†ç†±é»è¨˜éŒ„

ğŸ’¾ å¯«å…¥ç†±é»è³‡æ–™åˆ° hotspots table...
âœ… æˆåŠŸå¯«å…¥ 23 ç­†ç†±é»è¨˜éŒ„

ğŸ“Š åˆ†ææ‘˜è¦ï¼š
   ç¸½ç†±é»æ•¸: 23
   æ¶µè“‹äº‹æ•…ç¸½æ•¸: 1111
   - A1 (æ­»äº¡): 15 ç­†
   - A2 (å—å‚·): 398 ç­†
   - A3 (è²¡æ): 698 ç­†

   æœ€å±éšªç†±é»:
   - ä½ç½®: (25.0479123, 121.5170456)
   - äº‹æ•…æ•¸: 87 ç­†
   - åŠå¾‘: 450 å…¬å°º

============================================================
âœ¨ ETL å®Œæˆï¼
============================================================
```

### è³‡æ–™æµç¨‹åœ–

```
accidents table (åŸå§‹äº‹æ•…è³‡æ–™)
    â†“
[è®€å–éå» N å¤©çš„è³‡æ–™]
    â†“
[DBSCAN èšé¡åˆ†æ]
    â†“
[è¨ˆç®—ç†±é»çµ±è¨ˆè³‡è¨Š]
    â†“
hotspots table (ç†±é»åˆ†æçµæœ)
```

### ç†±é»æ¬„ä½è¨ˆç®—é‚è¼¯

#### ä¸­å¿ƒé» (center_latitude, center_longitude)

- ä½¿ç”¨èšé¡å…§æ‰€æœ‰äº‹æ•…çš„åº§æ¨™å¹³å‡å€¼

#### åŠå¾‘ (radius_meters)

- è¨ˆç®—æ‰€æœ‰äº‹æ•…é»åˆ°ä¸­å¿ƒçš„æœ€å¤§è·é›¢
- åŠ ä¸Š 20% ç·©è¡å€
- é™åˆ¶åœ¨ 50-2000 å…¬å°ºç¯„åœå…§

#### äº‹æ•…çµ±è¨ˆ (a1_count, a2_count, a3_count)

- æ ¹æ“šäº‹æ•…çš„ `source_type` æ¬„ä½çµ±è¨ˆ
- A1: æ­»äº¡äº‹æ•…
- A2: å—å‚·äº‹æ•…
- A3: è²¡æäº‹æ•…

#### æ™‚é–“ç¯„åœ (earliest_accident_at, latest_accident_at)

- è¨˜éŒ„ç†±é»å…§æœ€æ—©å’Œæœ€æ™šçš„äº‹æ•…ç™¼ç”Ÿæ™‚é–“

### å®šæœŸåŸ·è¡Œå»ºè­°

å»ºè­°æ¯å¤©æˆ–æ¯é€±åŸ·è¡Œä¸€æ¬¡ï¼Œä»¥ä¿æŒç†±é»è³‡æ–™çš„æ™‚æ•ˆæ€§ï¼š

```bash
# ä½¿ç”¨ cron jobï¼ˆæ¯å¤©å‡Œæ™¨ 2 é»åŸ·è¡Œï¼‰
0 2 * * * cd /path/to/project && uv run python data/generate_hotspots.py --database-url "$DATABASE_URL" --clear-existing

# æˆ–ä½¿ç”¨ systemd timer
# æˆ–æ•´åˆåˆ° CI/CD pipeline
```

### æ•…éšœæ’é™¤

#### äº‹æ•…æ•¸é‡ä¸è¶³

```
âš ï¸  äº‹æ•…æ•¸é‡ä¸è¶³ (3 < 5)ï¼Œç„¡æ³•é€²è¡Œåˆ†æ
```

**è§£æ±ºæ–¹å¼**ï¼š

- å¢åŠ  `--period-days` åƒæ•¸
- é™ä½ `--min-accidents` åƒæ•¸
- ç¢ºèª accidents table æœ‰è³‡æ–™

#### æœªç™¼ç¾ç†±é»

```
âœ… èšé¡å®Œæˆï¼š
   - ç™¼ç¾ 0 å€‹ç†±é»
   - å™ªéŸ³é»ï¼ˆæœªæ­¸é¡äº‹æ•…ï¼‰: 1523 ç­†
```

**è§£æ±ºæ–¹å¼**ï¼š

- å¢åŠ  `--epsilon-meters`ï¼ˆæ”¾å¯¬èšé¡åŠå¾‘ï¼‰
- é™ä½ `--min-accidents`ï¼ˆé™ä½æœ€å°äº‹æ•…æ•¸é–€æª»ï¼‰

#### ç†±é»éå¤š

```
âœ… ç™¼ç¾ 150 å€‹ç†±é»
```

**è§£æ±ºæ–¹å¼**ï¼š

- é™ä½ `--epsilon-meters`ï¼ˆæ›´åš´æ ¼çš„èšé¡ï¼‰
- å¢åŠ  `--min-accidents`ï¼ˆæé«˜æœ€å°äº‹æ•…æ•¸é–€æª»ï¼‰

### èˆ‡ç¾æœ‰ç³»çµ±æ•´åˆ

æ­¤è…³æœ¬ç¨ç«‹æ–¼ backend çš„ `HotspotAnalysisService`ï¼Œä½†ä½¿ç”¨ç›¸åŒçš„æ¼”ç®—æ³•å’Œé‚è¼¯ã€‚

å„ªé»ï¼š

- âœ… å¯ä»¥åœ¨ data pipeline ä¸­ç¨ç«‹åŸ·è¡Œ
- âœ… ä¸éœ€è¦å•Ÿå‹•æ•´å€‹ backend æœå‹™
- âœ… é©åˆ batch processing å’Œæ’ç¨‹åŸ·è¡Œ
- âœ… å®¹æ˜“æ•´åˆåˆ° ETL æµç¨‹ä¸­

å¦‚æœéœ€è¦åœ¨ backend API ä¸­å‹•æ…‹ç”Ÿæˆç†±é»ï¼Œè«‹ä½¿ç”¨ `HotspotAnalysisService.analyze()` æ–¹æ³•ã€‚
